{% extends "base.html" %}

{% block title %}Owner Dashboard - RentEase{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<style>
    .metric-card {
        transition: transform 0.2s;
    }
    .metric-card:hover {
        transform: translateY(-5px);
    }
    .chart-container {
        position: relative;
        height: 300px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <div>
            <h1 class="display-4 mb-0">Owner Dashboard</h1>
            <p class="lead text-muted mb-0">Manage your properties, bookings, and tenants</p>
        </div>
        <div>
            <a href="/upload-property" class="btn btn-primary btn-lg">
                <i class="bi bi-plus-circle"></i> Upload New Property
            </a>
        </div>
    </div>
</div>

<!-- Key Metrics Cards -->
<div class="row mb-4" id="keyMetrics">
    <div class="col-md-6 mb-3">
        <div class="card text-center metric-card border-primary">
            <div class="card-body">
                <i class="bi bi-house-door text-primary" style="font-size: 2rem;"></i>
                <h5 class="card-title mt-2">Total Properties</h5>
                <h2 class="text-primary mb-0" id="metricProperties">-</h2>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-3">
        <div class="card text-center metric-card border-info">
            <div class="card-body">
                <i class="bi bi-door-open text-info" style="font-size: 2rem;"></i>
                <h5 class="card-title mt-2">Occupancy Rate</h5>
                <h2 class="text-info mb-0" id="metricOccupancy">-</h2>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-3">
        <div class="card text-center metric-card border-success">
            <div class="card-body">
                <i class="bi bi-people text-success" style="font-size: 2rem;"></i>
                <h5 class="card-title mt-2">Active Tenants</h5>
                <h2 class="text-success mb-0" id="metricTenants">-</h2>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-3">
        <div class="card text-center metric-card border-warning">
            <div class="card-body">
                <i class="bi bi-exclamation-triangle text-warning" style="font-size: 2rem;"></i>
                <h5 class="card-title mt-2">Pending Actions</h5>
                <h2 class="text-warning mb-0" id="metricPending">-</h2>
            </div>
        </div>
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-4" id="dashboardTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">
            <i class="bi bi-speedometer2"></i> Overview
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="financial-tab" data-bs-toggle="tab" data-bs-target="#financial" type="button">
            <i class="bi bi-graph-up"></i> Financial
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="properties-tab" data-bs-toggle="tab" data-bs-target="#properties" type="button">
            <i class="bi bi-house-door"></i> Properties
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="bookings-tab" data-bs-toggle="tab" data-bs-target="#bookings" type="button">
            <i class="bi bi-calendar-check"></i> Bookings
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="tenants-tab" data-bs-toggle="tab" data-bs-target="#tenants" type="button">
            <i class="bi bi-people"></i> Tenants
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat" type="button">
            <i class="bi bi-chat-dots"></i> AI Chat
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="messaging-tab" data-bs-toggle="tab" data-bs-target="#messaging" type="button">
            <i class="bi bi-envelope"></i> Messaging
        </button>
    </li>
</ul>

<div class="tab-content" id="dashboardTabContent">
    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel">
        <div class="row mb-4">
            <div class="col-12">
                <h3>Property Status Overview</h3>
                <div class="table-responsive">
                    <table class="table table-hover" id="propertyStatusTable">
                        <thead>
                            <tr>
                                <th>Property</th>
                                <th>Location</th>
                                <th>Total Rooms</th>
                                <th>Available</th>
                                <th>Occupied</th>
                                <th>Occupancy Rate</th>
                                <th>Pending</th>
                                <th>Avg Rating</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="propertyStatusTableBody">
                            <tr>
                                <td colspan="9" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Financial Overview Tab -->
    <div class="tab-pane fade" id="financial" role="tabpanel">
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="card text-center border-success">
                    <div class="card-body">
                        <h5 class="card-title">Total Revenue</h5>
                        <h2 class="text-success" id="totalRevenue">₱0.00</h2>
                        <small class="text-muted">From confirmed payments</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card text-center border-info">
                    <div class="card-body">
                        <h5 class="card-title">Monthly Expected</h5>
                        <h2 class="text-info" id="monthlyExpected">₱0.00</h2>
                        <small class="text-muted">From active bookings</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card text-center border-warning">
                    <div class="card-body">
                        <h5 class="card-title">Pending Payments</h5>
                        <h2 class="text-warning" id="pendingPayments">₱0.00</h2>
                        <small class="text-muted" id="pendingCount">0 pending</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Monthly Revenue (Last 6 Months)</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="monthlyRevenueChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Revenue by Property</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="revenueByPropertyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Properties Tab -->
    <div class="tab-pane fade" id="properties" role="tabpanel">
        <div class="row" id="propertiesContainer">
            <div class="col-12 text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Bookings Tab -->
    <div class="tab-pane fade" id="bookings" role="tabpanel">
        <div class="mb-3">
            <select class="form-select" id="bookingFilter" onchange="filterBookings()">
                <option value="all">All Bookings</option>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
                <option value="cancelled">Cancelled</option>
                <option value="completed">Completed</option>
            </select>
        </div>
        <div class="table-responsive">
            <table class="table table-hover" id="bookingsTable">
                <thead>
                    <tr>
                        <th>Tenant</th>
                        <th>Property</th>
                        <th>Room Type</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="bookingsTableBody">
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

<!-- Tenants Tab -->
    <div class="tab-pane fade" id="tenants" role="tabpanel">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="tenantsTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Total Bookings</th>
                        <th>Active Bookings</th>
                        <th>Properties Rented</th>
                        <th>Room Types</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="8" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Tenant AI Chat Tab -->
    <div class="tab-pane fade" id="chat" role="tabpanel">
        <div id="tenantChatMessages" style="height: 400px; overflow-y: auto; border: 1px solid #dee2e6; padding: 1rem; margin-bottom: 1rem; border-radius: 0.25rem; background-color: #f8f9fa;">
            <div class="message assistant">
                <strong>AI:</strong> Hello! I'm your property management AI assistant. I can help you analyze your properties, tenants, bookings, and financial data. What would you like to know?
            </div>
        </div>
        <div class="input-group">
            <input type="text" class="form-control" id="tenantChatInput" placeholder="Ask about your tenants...">
            <button class="btn btn-primary" onclick="sendTenantChatMessage()">
                <i class="bi bi-send"></i> Send
            </button>
        </div>
    </div>

    <!-- Messaging Tab -->
    <div class="tab-pane fade" id="messaging" role="tabpanel">
        <div class="row">
            <div class="col-md-4">
                <div class="list-group" id="conversationsList">
                </div>
            </div>
            <div class="col-md-8">
                <div id="messageArea" style="height: 400px; border: 1px solid #dee2e6; padding: 1rem; border-radius: 0.25rem; overflow-y: auto; background-color: #f8f9fa;">
                    <div class="text-center text-muted">
                        <i class="bi bi-chat-left-text" style="font-size: 3rem;"></i>
                        <p class="mt-3">Select a conversation to start messaging</p>
                    </div>
                </div>
                <div class="input-group mt-3">
                    <input type="text" class="form-control" id="messageInput" placeholder="Type a message..." disabled>
                    <button class="btn btn-primary" id="sendMessageBtn" disabled>
                        <i class="bi bi-send"></i> Send
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel">Add Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="paymentForm">
                    <input type="hidden" id="paymentTenantId" name="tenant_id">
                    <div class="mb-3">
                        <label class="form-label">Tenant</label>
                        <input type="text" class="form-control" id="paymentTenantName" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="paymentBookingId" class="form-label">Booking <span class="text-danger">*</span></label>
                        <select class="form-select" id="paymentBookingId" name="booking_id" required>
                            <option value="">Loading bookings...</option>
                        </select>
                        <small class="form-text text-muted">Select the booking for this payment</small>
                    </div>
                    <div class="mb-3">
                        <label for="paymentAmount" class="form-label">Amount (₱) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="paymentAmount" name="amount_paid" step="0.01" min="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="paymentDate" class="form-label">Payment Date</label>
                        <input type="date" class="form-control" id="paymentDate" name="payment_date">
                        <small class="form-text text-muted">Leave empty to use today's date</small>
                    </div>
                    <div class="mb-3">
                        <label for="paymentMethod" class="form-label">Payment Method</label>
                        <select class="form-select" id="paymentMethod" name="payment_method">
                            <option value="Manual Entry" selected>Manual Entry</option>
                            <option value="Cash">Cash</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="GCash">GCash</option>
                            <option value="PayMaya">PayMaya</option>
                            <option value="Check">Check</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="paymentStatus" class="form-label">Status</label>
                        <select class="form-select" id="paymentStatus" name="status">
                            <option value="confirmed" selected>Confirmed</option>
                            <option value="pending">Pending</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitPayment()">Add Payment</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script>
    let allBookings = [];
    let monthlyRevenueChart = null;
    let revenueByPropertyChart = null;

    let tenantsTable = null;
    let bookingsTable = null;

    async function loadDashboard() {
        await Promise.all([
            loadKeyMetrics(),
            loadFinancialOverview(),
            loadPropertyStatus(),
            loadProperties(),
            loadBookings(),
            loadTenants()
        ]);
    }

    async function loadKeyMetrics() {
        try {
            const response = await fetch('/api/owner/metrics');
            const metrics = await response.json();
            
            document.getElementById('metricProperties').textContent = metrics.total_properties;
            document.getElementById('metricOccupancy').textContent = metrics.occupancy_rate + '%';
            document.getElementById('metricTenants').textContent = metrics.total_tenants;
            document.getElementById('metricPending').textContent = metrics.pending_bookings;
        } catch (error) {
            console.error('Error loading key metrics:', error);
        }
    }

    async function loadFinancialOverview() {
        try {
            const response = await fetch('/api/owner/financial-overview');
            const financial = await response.json();
            
            // Update financial cards
            document.getElementById('totalRevenue').textContent = 
                '₱' + financial.total_revenue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('monthlyExpected').textContent = 
                '₱' + financial.monthly_expected.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('pendingPayments').textContent = 
                '₱' + financial.pending_amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('pendingCount').textContent = 
                `${financial.pending_count} pending`;
            
            // Create monthly revenue chart
            const monthlyCtx = document.getElementById('monthlyRevenueChart');
            if (monthlyRevenueChart) {
                monthlyRevenueChart.destroy();
            }
            
            const monthlyLabels = financial.monthly_revenue.map(r => {
                const [year, month] = r.month.split('-');
                const date = new Date(year, month - 1);
                return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            });
            const monthlyData = financial.monthly_revenue.map(r => parseFloat(r.revenue));
            
            monthlyRevenueChart = new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: monthlyLabels,
                    datasets: [{
                        label: 'Revenue (₱)',
                        data: monthlyData,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₱' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
            // Create revenue by property chart
            const propertyCtx = document.getElementById('revenueByPropertyChart');
            if (revenueByPropertyChart) {
                revenueByPropertyChart.destroy();
            }
            
            const propertyLabels = financial.revenue_by_property.map(p => p.property_name);
            const propertyData = financial.revenue_by_property.map(p => parseFloat(p.revenue));
            
            revenueByPropertyChart = new Chart(propertyCtx, {
                type: 'bar',
                data: {
                    labels: propertyLabels,
                    datasets: [{
                        label: 'Revenue (₱)',
                        data: propertyData,
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(255, 99, 132, 0.6)',
                            'rgba(255, 206, 86, 0.6)',
                            'rgba(75, 192, 192, 0.6)',
                            'rgba(153, 102, 255, 0.6)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₱' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error loading financial overview:', error);
        }
    }

    async function loadPropertyStatus() {
        try {
            const response = await fetch('/api/owner/property-status');
            const properties = await response.json();
            
            const tbody = document.getElementById('propertyStatusTableBody');
            
            if (properties.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">No properties found.</td></tr>';
                return;
            }
            
            tbody.innerHTML = properties.map(prop => `
                <tr>
                    <td><strong>${escapeHtml(prop.property_name)}</strong></td>
                    <td>${escapeHtml(prop.location)}</td>
                    <td>${prop.total_rooms}</td>
                    <td><span class="badge bg-success">${prop.available_rooms}</span></td>
                    <td><span class="badge bg-info">${prop.occupied_rooms}</span></td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar" role="progressbar" 
                                 style="width: ${prop.occupancy_rate}%" 
                                 aria-valuenow="${prop.occupancy_rate}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                ${prop.occupancy_rate}%
                            </div>
                        </div>
                    </td>
                    <td><span class="badge bg-warning">${prop.pending_bookings}</span></td>
                    <td>
                        ${prop.avg_rating > 0 ? `
                            <span class="badge bg-success">${prop.avg_rating} ⭐</span>
                            <small class="text-muted">(${prop.total_reviews} reviews)</small>
                        ` : '<span class="text-muted">No reviews</span>'}
                    </td>
                    <td>
                        <a href="/property/${prop.property_id}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-eye"></i> View
                        </a>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error loading property status:', error);
        }
    }

    async function loadProperties() {
        try {
            const response = await fetch('/api/owner/properties');
            const properties = await response.json();
            
            const container = document.getElementById('propertiesContainer');
            if (properties.length === 0) {
                container.innerHTML = '<div class="alert alert-info">You don\'t have any properties yet.</div>';
                return;
            }

            container.innerHTML = properties.map(property => `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0">${escapeHtml(property.property_name)}</h5>
                                ${property.status ? `
                                    <span class="badge bg-${property.status === 'approved' ? 'success' : property.status === 'pending' ? 'warning' : 'danger'}">
                                        ${escapeHtml(property.status)}
                                    </span>
                                ` : ''}
                            </div>
                            <p class="card-text text-muted">
                                <i class="bi bi-geo-alt"></i> ${escapeHtml(property.location)}
                            </p>
                            <p class="card-text">${escapeHtml(property.description || '').substring(0, 100)}${property.description && property.description.length > 100 ? '...' : ''}</p>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">
                                    <i class="bi bi-door-open"></i> ${property.available_rooms || 0} / ${property.total_rooms || 0} rooms
                                </small>
                                <small class="text-muted">
                                    <i class="bi bi-calendar"></i> ${formatDate(property.date_posted)}
                                </small>
                            </div>
                            ${property.status === 'pending' ? `
                                <div class="alert alert-warning alert-sm mt-2 mb-0 py-2">
                                    <small><i class="bi bi-clock"></i> Waiting for admin approval</small>
                                </div>
                            ` : ''}
                        </div>
                        <div class="card-footer bg-transparent">
                            ${property.status === 'approved' ? `
                                <a href="/property/${property.property_id}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-eye"></i> View Details
                                </a>
                            ` : `
                                <span class="text-muted small">Not yet published</span>
                            `}
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('totalProperties').textContent = properties.length;
        } catch (error) {
            console.error('Error loading properties:', error);
        }
    }

    async function loadBookings() {
        try {
            const response = await fetch('/api/owner/bookings');
            allBookings = await response.json();
            displayBookings(allBookings);
            updateStats();
        } catch (error) {
            console.error('Error loading bookings:', error);
        }
    }

    function displayBookings(bookings) {
        const tbody = document.getElementById('bookingsTableBody');
        
        if (bookings.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">No bookings found.</td></tr>';
            if (bookingsTable) {
                bookingsTable.destroy();
                bookingsTable = null;
            }
            return;
        }

        tbody.innerHTML = bookings.map(booking => `
            <tr>
                <td>
                    <strong>${escapeHtml(booking.tenant_name)}</strong><br>
                    <small class="text-muted">${escapeHtml(booking.tenant_email)}</small>
                </td>
                <td>${escapeHtml(booking.property_name)}</td>
                <td><span class="badge bg-info">${escapeHtml(booking.room_type)}</span></td>
                <td>${formatDate(booking.start_date)}</td>
                <td>${booking.end_date ? formatDate(booking.end_date) : 'N/A'}</td>
                <td><span class="badge bg-${getStatusColor(booking.status)}">${escapeHtml(booking.status)}</span></td>
                <td>
                    ${booking.status === 'pending' ? `
                        <button class="btn btn-sm btn-success" onclick="updateBookingStatus(${booking.booking_id}, 'approved')">
                            <i class="bi bi-check"></i> Approve
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="updateBookingStatus(${booking.booking_id}, 'rejected')">
                            <i class="bi bi-x"></i> Reject
                        </button>
                    ` : '-'}
                </td>
            </tr>
        `).join('');

        // Initialize or refresh DataTable
        if (bookingsTable) {
            bookingsTable.destroy();
        }
        bookingsTable = $('#bookingsTable').DataTable({
            order: [[3, 'desc']], // Sort by start date descending
            pageLength: 10,
            responsive: true
        });

        document.getElementById('totalBookings').textContent = allBookings.length;
        document.getElementById('pendingBookings').textContent = allBookings.filter(b => b.status === 'pending').length;
    }

    function filterBookings() {
        const filter = document.getElementById('bookingFilter').value;
        let filtered;
        if (filter === 'all') {
            filtered = allBookings;
        } else {
            filtered = allBookings.filter(b => b.status === filter);
        }
        displayBookings(filtered);
    }

    async function updateBookingStatus(bookingId, status) {
        if (!confirm(`Are you sure you want to ${status} this booking?`)) {
            return;
        }
        
        try {
            const response = await fetch(`/api/owner/bookings/${bookingId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: status })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                alert(`Booking ${status} successfully!`);
                // Reload bookings, metrics, and property status to reflect changes
                await Promise.all([
                    loadBookings(),
                    loadKeyMetrics(),
                    loadPropertyStatus()
                ]);
            } else {
                alert('Error: ' + (data.error || 'Failed to update booking status'));
            }
        } catch (error) {
            console.error('Error updating booking status:', error);
            alert('Error updating booking status. Please try again.');
        }
    }

    async function loadTenants() {
        try {
            const response = await fetch('/api/owner/tenants');
            const tenants = await response.json();
            
            const tbody = document.querySelector('#tenantsTable tbody');
            
            if (tenants.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">You don\'t have any tenants yet.</td></tr>';
                if (tenantsTable) {
                    tenantsTable.destroy();
                    tenantsTable = null;
                }
                return;
            }

            tbody.innerHTML = tenants.map(tenant => `
                <tr>
                    <td>
                        ${escapeHtml(tenant.full_name)}
                        <button class="btn btn-sm btn-primary ms-2" onclick="openPaymentModal(${tenant.tenant_id}, '${escapeHtml(tenant.full_name)}')" title="Add Payment">
                            <i class="bi bi-cash-coin"></i> Add Payment
                        </button>
                    </td>
                    <td>${escapeHtml(tenant.email)}</td>
                    <td>${escapeHtml(tenant.phone_number || 'N/A')}</td>
                    <td>${tenant.total_bookings || 0}</td>
                    <td><span class="badge bg-success">${tenant.active_bookings || 0}</span></td>
                    <td>${escapeHtml(tenant.properties_rented || 'None')}</td>
                    <td>${escapeHtml(tenant.room_types || 'N/A')}</td>
                    <td>-</td>
                </tr>
            `).join('');

            // Initialize or refresh DataTable
            if (tenantsTable) {
                tenantsTable.destroy();
            }
            tenantsTable = $('#tenantsTable').DataTable({
                order: [[0, 'asc']],
                pageLength: 10,
                responsive: true
            });
        } catch (error) {
            console.error('Error loading tenants:', error);
        }
    }

    async function sendTenantChatMessage() {
        const input = document.getElementById('tenantChatInput');
        const message = input.value.trim();
        if (!message) return;

        const messagesDiv = document.getElementById('tenantChatMessages');
        
        // Add user message
        const userMsg = document.createElement('div');
        userMsg.className = 'message user';
        userMsg.innerHTML = `<strong>You:</strong> ${escapeHtml(message)}`;
        messagesDiv.appendChild(userMsg);
        
        input.value = '';
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        // Show loading indicator
        const loadingMsg = document.createElement('div');
        loadingMsg.className = 'message assistant';
        loadingMsg.id = 'loadingMsg';
        loadingMsg.innerHTML = `<strong>AI:</strong> <em>Analyzing data...</em>`;
        messagesDiv.appendChild(loadingMsg);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        // Send to API
        try {
            const response = await fetch('/api/owner/tenant-chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message: message })
            });
            
            const data = await response.json();
            
            // Remove loading message
            const loading = document.getElementById('loadingMsg');
            if (loading) loading.remove();
            
            const aiMsg = document.createElement('div');
            aiMsg.className = 'message assistant';
            // Format the response: convert line breaks and markdown to HTML
            let responseText = data.response || data.error || 'Sorry, I encountered an error.';
            // First, convert markdown to HTML (before escaping)
            responseText = responseText
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold markdown
                .replace(/\*(?![*])(.*?)\*/g, '<em>$1</em>'); // Italic markdown (not bold)
            // Escape HTML to prevent XSS
            responseText = escapeHtml(responseText);
            // Convert escaped <br> back to actual <br> tags, and convert \n to <br>
            responseText = responseText
                .replace(/&lt;br&gt;/g, '<br>')
                .replace(/\\n/g, '<br>')
                .replace(/\n/g, '<br>')
                .replace(/&lt;strong&gt;(.*?)&lt;\/strong&gt;/g, '<strong>$1</strong>')
                .replace(/&lt;em&gt;(.*?)&lt;\/em&gt;/g, '<em>$1</em>');
            aiMsg.innerHTML = `<strong>AI:</strong> ${responseText}`;
            messagesDiv.appendChild(aiMsg);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        } catch (error) {
            // Remove loading message
            const loading = document.getElementById('loadingMsg');
            if (loading) loading.remove();
            
            const aiMsg = document.createElement('div');
            aiMsg.className = 'message assistant';
            aiMsg.innerHTML = `<strong>AI:</strong> Sorry, I encountered an error. Please try again.`;
            messagesDiv.appendChild(aiMsg);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    }

    document.getElementById('tenantChatInput')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendTenantChatMessage();
        }
    });

    function getStatusColor(status) {
        const colors = {
            'pending': 'warning',
            'approved': 'success',
            'rejected': 'danger',
            'cancelled': 'secondary',
            'completed': 'info'
        };
        return colors[status] || 'secondary';
    }


    // Payment Modal Functions
    async function openPaymentModal(tenantId, tenantName) {
        document.getElementById('paymentTenantId').value = tenantId;
        document.getElementById('paymentTenantName').value = tenantName;
        
        const bookingSelect = document.getElementById('paymentBookingId');
        bookingSelect.innerHTML = '<option value="">Loading bookings...</option>';
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
        modal.show();
        
        // Load bookings for this tenant
        try {
            const response = await fetch(`/api/owner/tenants/${tenantId}/bookings`);
            const bookings = await response.json();
            
            if (bookings.length === 0) {
                bookingSelect.innerHTML = '<option value="">No approved bookings found for this tenant</option>';
                bookingSelect.disabled = true;
                return;
            }
            
            bookingSelect.innerHTML = '<option value="">Select a booking...</option>';
            bookings.forEach(booking => {
                const option = document.createElement('option');
                option.value = booking.booking_id;
                option.textContent = `${booking.property_name} - ${booking.room_type} (₱${booking.monthly_rate}/month) - ${formatDate(booking.start_date)}`;
                option.dataset.roomId = booking.room_id;
                bookingSelect.appendChild(option);
            });
            bookingSelect.disabled = false;
        } catch (error) {
            console.error('Error loading bookings:', error);
            bookingSelect.innerHTML = '<option value="">Error loading bookings</option>';
            bookingSelect.disabled = true;
        }
        
        // Set today's date as default
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('paymentDate').value = today;
    }

    async function submitPayment() {
        const form = document.getElementById('paymentForm');
        const formData = new FormData(form);
        
        // Validate required fields
        const bookingId = formData.get('booking_id');
        const amount = formData.get('amount_paid');
        
        if (!bookingId || !amount) {
            alert('Please fill in all required fields');
            return;
        }
        
        // Prepare payment data
        const paymentData = {
            booking_id: parseInt(bookingId),
            tenant_id: parseInt(formData.get('tenant_id')),
            amount_paid: parseFloat(amount),
            payment_date: formData.get('payment_date') || null,
            payment_method: formData.get('payment_method') || 'Manual Entry',
            status: formData.get('status') || 'confirmed'
        };
        
        try {
            const response = await fetch('/api/owner/payments', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(paymentData)
            });
            
            const data = await response.json();
            
            if (response.ok) {
                alert('Payment added successfully!');
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('paymentModal'));
                modal.hide();
                // Reset form
                form.reset();
                // Reload financial data
                loadFinancialOverview();
            } else {
                alert('Error: ' + (data.error || 'Failed to add payment'));
            }
        } catch (error) {
            console.error('Error submitting payment:', error);
            alert('Error submitting payment. Please try again.');
        }
    }

    // Load dashboard on page load
    loadDashboard();
</script>
{% endblock %}

